<html lang="en" layout:decorate="~{/common/layout.html}" xmlns:th="http://www.w3.org/1999/xhtml" xmlns:layout="">
<head>
    <title>Book</title>
</head>

<main layout:fragment="main">
    <!--  정렬순  -->
    <select id="sortOption">
        <option value="createDate">등록일순</option>
        <option value="preferenceCount">추천순</option> <!-- JPA에서 지원하는 함수나 필드를 이용 -->
        <option value="commentCount">댓글순</option> <!-- JPA에서 지원하는 함수나 필드를 이용 -->
    </select>
    <!--  검색 시작  -->
    <div class="row my-3">
        <div class="col-6">
            <div class="input-group">
                <input type="text" id="search_kw" class="form-control" th:value="${kw}">
                <button class="btn btn-outline-secondary" type="button" id="btn_search">찾기</button>
            </div>
        </div>
    </div>
    <!--  검색 끝  -->
<!--    <div class="container mx-auto" style="min-height: 101vh;">-->
<!--        <div class="grid grid-cols-4 gap-4">-->
<!--            &lt;!&ndash; Thymeleaf loop to iterate over the questions &ndash;&gt;-->
<!--            <div th:each="book : ${paging}">-->
<!--                <div class="card border rounded p-4">-->
<!--                    <a href="|/books/${book.id}/details|">-->
<!--                        <img th:src="@{${book.coverImgUrl}}" alt="Book Image">-->
<!--                        <h2 th:text="${book.title}"></h2>-->
<!--                    </a>-->
<!--                    &lt;!&ndash;                    <a href="javascript:void(0);" class="recommend btn btn-sm btn-outline-secondary"&ndash;&gt;-->
<!--                    &lt;!&ndash;                       th:data-uri="@{|/book/vote/${book.id}|}">&ndash;&gt;-->
<!--                    &lt;!&ndash;                        추천&ndash;&gt;-->
<!--                    &lt;!&ndash;                        <span class="badge rounded-pill bg-success" th:text="${#lists.size(book.voters)}"></span>&ndash;&gt;-->
<!--                    &lt;!&ndash;                    </a>&ndash;&gt;-->
<!--                    <p th:text="${book.author.nickname}"></p>-->
<!--                    <p th:text="${book.createDate}"></p>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->

    <div style="min-height: 100vh;">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 xl:grid-cols-5 gap-x-6 xl:gap-x-8">
            <div th:each="book : ${paging}">
                <div class="rounded-md aspect-h-16 aspect-w-11 xl:aspect-h-11 xl:aspect-w-16 w-full overflow-hidden shadow-lg transition-all duration-150 ease-in-out hover:z-1 hover:transform hover:scale-110 group mb-8">
                    <div>
                        <a th:href="@{|/books/${book.id}/details|}">
                            <div class="relative">
                                <img th:src="@{${book.coverImgUrl}}" alt="Book Image" class="object-cover transition-all duration-1000 ease-in-out group-hover:transform group-hover:scale-110 rounded-lg" style="backface-visibility: hidden;">
                                <div class="absolute bottom-0 left-0 text-red right-0">
                                    <div class="  p-4">
                                        <div class="mb-4">
                                            <h1 th:text="${book.title}" class="font-extrabold text-lg text-center overflow-hidden"></h1>
                                        </div>
                                        <div class="text-slate-400	font-medium">
                                            <h2 th:text="${book.author.nickname}" ></h2>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form th:action="@{/books}" method="get" id="searchForm">
        <input type="hidden" id="kw" name="kw" th:value="${kw}">
        <input type="hidden" id="page" name="page" th:value="${paging.number}">
        <input type="hidden" id="sort" name="sort" th:value="${sort}">
    </form>

    <script type='text/javascript'>
        let currentPage = 0;
          let isLoading = false;
          let reachedEnd = false;

  window.addEventListener('scroll', function() {
    console.log('Scroll event triggered');
      if (isLoading || reachedEnd) return;

      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
        console.log('Reached bottom');  // 이 로그를 통해 페이지 하단 도달 확인
          isLoading = true;
          currentPage++;
          fetchMoreBooks(currentPage);
      }
  });

  function fetchMoreBooks(page) {
       fetch(`/api/books/list?page=${page}&kw=${document.getElementById('search_kw').value}&sort=${document.getElementById('sortOption').value}`)
          .then(response => {
              console.log('Server Response:', response); // 서버 응답 로깅

              return response.json();
          })
          .then(data => {
              console.log('Data:', data); // 데이터 형식 로깅
              isLoading = false;
              if (Array.isArray(data)) {
                  if (data.length === 0) {
                      reachedEnd = true;
                      return;
                  }
                  appendBooksToDOM(data);
              } else {
                  console.error('Received data is not an array.');
              }
          })
          .catch(error => {
              console.error('Fetch Error:', error); // 에러 로깅
          });
  }

  function appendBooksToDOM(data) {
            const bookContainer = document.querySelector('.grid.grid-cols-1.sm\\:grid-cols-2.md\\:grid-cols-3.lg\\:grid-cols-5.xl\\:grid-cols-5.gap-x-6.xl\\:gap-x-8');

            const fragment = document.createDocumentFragment();
            data.forEach(book => {
                // 각 책에 대한 HTML 요소를 생성하고 컨테이너에 추가
                const bookElement = createBookElement(book);
                fragment.appendChild(bookElement);
            });

            bookContainer.appendChild(fragment);
        }

  // 책 요소를 생성하는 함수
  // 새로운 책이 추가가 될 때 태그별로 클래스를 추가하여 효과적용 시킴!!
  function createBookElement(book) {
             const div = document.createElement('div');
             div.classList.add('rounded-md', 'aspect-h-16', 'aspect-w-11', 'xl:aspect-h-11', 'xl:aspect-w-16', 'w-full', 'overflow-hidden', 'shadow-lg', 'transition-all', 'duration-150', 'ease-in-out', 'hover:z-1' , 'hover:transform' , 'hover:scale-110' ,'group', 'mb-8');
             const link = document.createElement('a');
             link.href = `/books/${book.id}/details`;

             const relativeDiv = document.createElement('div');
             relativeDiv.classList.add('relative');

             const img = document.createElement('img');
             img.src = book.coverImgUrl;
             img.alt = 'Book Image';
             img.classList.add('object-cover', 'transition-all', 'duration-1000', 'ease-in-out', 'group-hover:transform', 'group-hover:scale-110', 'rounded-lg');
             const absoluteDiv = document.createElement('div');
             absoluteDiv.classList.add('absolute', 'bottom-0', 'left-0', 'text-white', 'right-0');

             const innerDiv = document.createElement('div');
             innerDiv.classList.add('p-4');

             const titleDiv = document.createElement('div');
             titleDiv.classList.add('mb-4');

             const titleH1 = document.createElement('h1');
             titleH1.classList.add('font-extrabold', 'text-lg', 'text-center', 'overflow-hidden');
             titleH1.textContent = book.title;

             const authorDiv = document.createElement('div');
             authorDiv.classList.add('text-slate-400', 'font-medium');

             const authorH2 = document.createElement('h2');
             authorH2.textContent = book.author.nickname;

             // 조립
             titleDiv.appendChild(titleH1);
             authorDiv.appendChild(authorH2);
             innerDiv.appendChild(titleDiv);
             innerDiv.appendChild(authorDiv);
             absoluteDiv.appendChild(innerDiv);
             relativeDiv.appendChild(img);
             relativeDiv.appendChild(absoluteDiv);
             link.appendChild(relativeDiv);
             div.appendChild(link);

             return div;
           }


  const btn_search = document.getElementById("btn_search");
  btn_search.addEventListener('click', function() {
      document.getElementById('kw').value = document.getElementById('search_kw').value;
      document.getElementById('page').value = 0;  // 검색버튼을 클릭할 경우 0페이지부터 조회한다.
      document.getElementById('searchForm').submit();
  });

           const sortOption = document.getElementById("sortOption");
sortOption.addEventListener('change', function() {
    const selectedOption = this.value;
    document.getElementById('sort').value = selectedOption; // Hidden input에 sort 값 설정
    document.getElementById('searchForm').submit();  // 폼 제출
});
    </script>
</main>
</html>