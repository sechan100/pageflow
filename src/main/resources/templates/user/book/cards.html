<html lang="en" layout:decorate="~{/common/layout.html}" xmlns:th="http://www.w3.org/1999/xhtml">

<head>
    <title>Books</title>

<!--  select 정렬순 스타일  -->
    <style>
       .btn-select.on+.list-member {
                  display: block;
                }

                // block 성질 중요
                .list-member li {
                  width: 100%;
                  height: 40px;
                  box-sizing: border-box;
                }

                .list-member li button {
                  width: 100%;
                  padding: 7px 10px;
                  background-color: #fff;
                  cursor: pointer;
                  text-align: left;
                  white-space: nowrap;
                  text-overflow: ellipsis;
                  overflow: hidden;
                }

                .list-member li button:hover,
                .list-member li button:focus {
                  background-color: rgb(203 213 225);
                }
    </style>
</head>

<main layout:fragment="main">

    <div class="flex flex-col w-full">
        <div class="relative h-[30vh] flex items-center justify-center ">
            <!-- 상단 이미지 -->
            <div class="absolute inset-0 overflow-hidden drop-shadow-2xl shadow-2xl">
                <img src="https://img1.daumcdn.net/thumb/R1280x0/?fname=http://t1.daumcdn.net/brunch/service/user/9kE1/image/k3uEfFMvJOS81qkiAml4EMnsVzs.jpg"
                     alt="Background Image" class="w-full h-full object-cover filter grayscale">
            </div>

            <!-- 상단 이미지 글귀 -->
            <div class="absolute  bottom-10  left-10 text-white text-left z-10 ">
                <h1 class="text-5xl font-black  mb-8">PageFlow </h1>
                <p class="text-3xl font-bold">Dive into a world of diverse stories and authors right now!</p>
            </div>
        </div>
        <!-- 리스트 -->
        <div class="w-full mx-auto max-w-screen-xl sm:px-6 sm:py-24  ">
            <div class="flex justify-between mb-16 w-full  ">
            <div class="flex grow">
                <!--  정렬순  -->
                <div class="max-w-md mr-4 w-1/5 z-10  border-2 p-3 border-gray-400 rounded font-semibold text-sm text-gray-600 relative text-center active:top-[3px]">
                    <button id="sortOption" name="sort" th:value="${sort}" data-sort="${sort}"
                            class="btn-select w-full cursor-pointer  overflow-hidden">
                        정렬순
                    </button>
                    <ul class="list-member list-none hidden absolute w-full rounded font-medium text-black text-sm  top-16 left-0">
                        <li>
                            <button value="createDate" type="button" onclick="updateSort('createDate')">작성 날짜</button>
                        </li>
                        <li>
                            <button value="title" type="button" onclick="updateSort('title')">제목</button>
                        </li>
                        <li>
                            <button type="button" onclick="updateSort('recommend')">추천</button>
                        </li>
                    </ul>
                </div>
            </div>
            <!--  검색 시작  -->
                <div class="w-full flex justify-between max-w-md   ">
                    <input id="search_kw" th:value="${kw}" name="search_kw" type="text" autocomplete="search_kw"
                           placeholder="검색어를 입력해주세요" required
                           class="input w-2/3 focus:border-double focus:border-gray-500 focus:ring-0 rounded max-w-xs flex-auto text-black border-gray-400 sm:text-sm sm:leading-6 ">
                    <button id="btn_search" type="button"
                            class="font-semibold rounded border-2 p-3 border-gray-400 text-sm text-gray-600 relative text-center active:top-[3px]   w-1/4 ">
                    검색
                </button>
            </div>
            <!--  검색 끝  -->
        </div>
            <!-- 리스트 -->
            <div style="min-height: 100vh ;">
                <div class="grid grid-cols-4 gap-x-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-4 xl:gap-x-8  " >
                    <div th:each="book : ${paging}" class="h-4/5">
                        <div class="h-full w-full shadow-lg">
                            <a th:href="@{|/book/detail/${book.id}|}"
                               class="relative font-bold text-md text-center text-white">
                                <div class="h-full w-full overflow-hidden bg-cover bg-center">
                                    <img th:src="@{${book.coverImgUrl}}" alt="Book Image"
                                         class="h-full w-full group-hover:opacity-75  ">
                                </div>
                                <h1 th:text="${book.title}" class="absolute inset-x-0 top-0 mt-4 "></h1>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <form th:action="@{/book}" method="get" id="searchForm">
            <input type="hidden" id="kw" name="kw" th:value="${kw}">
            <input type="hidden" id="page" name="page" th:value="${paging.number}">
            <input type="hidden" id="sort" name="sort" th:value="${sort}">
        </form>
    </div>
    <script type='text/javascript'>
        const btn = document.querySelector(".btn-select");
const list = document.querySelector(".list-member");
btn.addEventListener("click", () => {
btn.classList.toggle("on");
});
list.addEventListener("click", (event) => {
if (event.target.nodeName === "BUTTON") {
btn.innerText = event.target.innerText;
btn.classList.remove("on");
}
});

    </script>
    <script type='text/javascript'>
        let currentPage = 0;
          let isLoading = false;
          let reachedEnd = false;

  window.addEventListener('scroll', function() {
    console.log('Scroll event triggered');
      if (isLoading || reachedEnd) return;

      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
        console.log('Reached bottom');  // 이 로그를 통해 페이지 하단 도달 확인
          isLoading = true;
          currentPage++;
          fetchMoreBooks(currentPage);
      }
  });

  function fetchMoreBooks(page) {
       fetch(`/api/book/list?page=${page}&kw=${document.getElementById('search_kw').value}&sort=${document.getElementById('sortOption').value}`)
          .then(response => {
              console.log('Server Response:', response); // 서버 응답 로깅

              return response.json();
          })
          .then(data => {
              console.log('Data:', data); // 데이터 형식 로깅
              isLoading = false;
              if (Array.isArray(data)) {
                  if (data.length === 0) {
                      reachedEnd = true;
                      return;
                  }
                  appendBooksToDOM(data);
              } else {
                  console.error('Received data is not an array.');
              }
          })
          .catch(error => {
              console.error('Fetch Error:', error); // 에러 로깅
          });
  }

  function appendBooksToDOM(data) {
      const bookContainer = document.querySelector('.grid.grid-cols-4.gap-4');
      data.forEach(book => {
          const bookElement = `
                    <div class="card border rounded p-4">
                <a href="/book/detail/${book.id}">
                    <img src="${book.coverImgUrl}" alt="Book Image">
                    <h2>${book.title}</h2>
                </a>
<!--                <a href="javascript:void(0);" class="recommend btn btn-sm btn-outline-secondary">-->
<!--                    추천-->
<!--                    <span class="badge rounded-pill bg-success">${book.voters.length}</span>-->
<!--                </a>-->
                <p>${book.author.nickname}</p>
                <p>${book.createDate}</p>
            </div>
          `;
          bookContainer.innerHTML += bookElement;
      });
  }

  const btn_search = document.getElementById("btn_search");
  btn_search.addEventListener('click', function() {
      document.getElementById('kw').value = document.getElementById('search_kw').value;
      document.getElementById('page').value = 0;  // 검색버튼을 클릭할 경우 0페이지부터 조회한다.
      document.getElementById('searchForm').submit();
  });

          const recommend_elements = document.getElementsByClassName("recommend");
           Array.from(recommend_elements).forEach(function(element) {
               element.addEventListener('click', function() {
                   if(confirm("정말로 추천하시겠습니까?")) {
                       location.href = this.dataset.uri;
                   };
               });
           });

           const sortOption = document.getElementById("sortOption");
sortOption.addEventListener('change', function() {
    const selectedOption = this.value;
    document.getElementById('sort').value = selectedOption; // Hidden input에 sort 값 설정
    console.log('작동중?');
    document.getElementById('searchForm').submit();  // 폼 제출
    console.error('dd');
});

   const sortOptionButton = document.getElementById("sortOption");
    const searchForm = document.getElementById('searchForm');

    function updateSort(newSort) {
        // Hidden input에 정렬값 설정
        document.getElementById('sort').value = newSort;

        // 버튼에 텍스트 업데이트
        sortOptionButton.innerText = getButtonText(newSort);

        // 폼 제출
        searchForm.submit();
    }

    // 정렬값에 따라 버튼 텍스트를 반환하는 함수
    function getButtonText(sortOption) {
        switch (sortOption) {
            case 'createDate':
                return '작성 날짜';
            case 'title':
                return '제목';
            case 'recommend':
                return '추천';
            default:
                return '정렬순';
        }
    }
    </script>


    </div>

</main>
</html>